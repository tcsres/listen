<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setlist Oluşturucu by TCS</title>
    <style>
        body {
            font-family: 'Helvetica', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: left;
            justify-content: left;
            text-align: left;
            margin: 0;
            padding: 20px;
            background-color: #C8C8C8;
        }
        input, button {
            margin: 10px;
            padding: 10px;
            font-family: 'Helvetica', sans-serif;
            font-size: 16px;
            justify-content: left;
            text-align: left;
        }
        label {
            font-weight: bold;
            margin-left: 20px;
        }
        button {
            cursor: pointer;
            border: none;
            background-color: #0B5C88;
            color: white;
            border-radius: 5px;
            transition: background-color 0.3s;
            justify-content: left;
            text-align: left;
        }
        button:hover {
            background-color: #0A4A6D;
        }
        #setlist {
            margin-top: 20px;
            width: 90%;
            max-height: 200px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            border: 1px solid #ccc;
        }
        .draggable {
            border: 1px solid #A5A5A5;
            text-align: left;
            padding-left: 40px;
            font-weight: bold;
        }
        #total-time {
            margin-top: 10px;
            font-weight: bold;
            font-size: 20px;
            background-color: #868695;
            padding: 10px;
            border-radius: 5px;
            color: #fff;
        }
        .delete-button {
            margin-left: 10px;
            padding: 5px;
            background-color: #868695;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        .delete-button:hover {
            background-color: #787889;
        }
        .draggable {
            cursor: move;
        }
        @media (max-width: 600px) {
            input, button {
                font-size: 14px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>

<label for="sureLimit">Toplam Setlist Süresi (dakika):</label>
<input type="number" id="sureLimit" min="1" placeholder="Toplam süre girin">

<label for="sarkiAdi">Şarkı Adı:</label>
<input type="text" id="sarkiAdi" placeholder="Şarkı adı girin">

<label for="sarkiSure">Şarkı Süresi (dakika:saniye):</label>
<input type="text" id="sarkiSure" placeholder="örn. 2:16 veya 2.16">

<button onclick="sarkiEkle()">Şarkı Ekle</button>

<div id="total-time">Toplam Süre: 0 dakika</div>

<ul id="setlist"></ul>

<input type="file" id="fileInput" accept=".txt" style="display: none;" onchange="importList(event)">
<button onclick="document.getElementById('fileInput').click()">Listeyi İçe Aktar</button>
<button onclick="exportList()">Listeyi Dışa Aktar</button>

<input type="text" id="urlInput" placeholder="URL'den listeyi yükle">
<button onclick="importFromURL()">URL'den İçe Aktar</button>

<!-- PDFMake Kütüphaneleri -->
<script src="https://tolgacansaygili.github.io/test/lib/pdfmake.min.js"></script>
<script src="https://tolgacansaygili.github.io/test/lib/vfs_fonts.js"></script>

<button onclick="exportPDF()">PDF Olarak Kaydet</button>

<script>
    let sarkilar = [];

function sarkiEkle() {
    const sarkiAdi = document.getElementById('sarkiAdi').value;
    const sarkiSure = document.getElementById('sarkiSure').value;
    const sureLimit = parseFloat(document.getElementById('sureLimit').value);

    if (!sarkiAdi || !isValidTimeFormat(sarkiSure)) {
        alert('Lütfen geçerli bir şarkı adı ve süre girin.');
        return;
    }

    // Süreyi dakika:saniye formatında işle
    const [dakika, saniye] = sarkiSure.includes(':')
        ? sarkiSure.split(':').map(Number)
        : [Math.floor(parseFloat(sarkiSure)), (parseFloat(sarkiSure) % 1) * 60];

    const sureDakika = dakika + saniye / 60;

    const toplamSure = sarkilar.reduce((acc, sarki) => acc + sarki.sure, 0);
    if (toplamSure + sureDakika > sureLimit) {
        alert(`Toplam süre ${sureLimit} dakikayı aşamaz!`);
        return;
    }

    sarkilar.push({ isim: sarkiAdi, sure: sureDakika });
    listeGuncelle();

    document.getElementById('sarkiAdi').value = '';
    document.getElementById('sarkiSure').value = '';
}

function isValidTimeFormat(time) {
    const regex = /^(\d{1,2}(\.\d{1,2})?)$/;
    const regexColon = /^(\d{1,2}:\d{1,2})$/;

    if (regex.test(time) || regexColon.test(time)) {
        return true;
    } else {
        alert('Geçerli bir süre formatı giriniz (örneğin 2:16, 02.16).');
        return false;
    }
}

function listeGuncelle() {
    const setlistElement = document.getElementById('setlist');
    setlistElement.innerHTML = '';

    sarkilar.forEach((sarki, index) => {
        const li = document.createElement('li');
        const dakika = Math.floor(sarki.sure);
        const saniye = Math.round((sarki.sure - dakika) * 60);
        li.textContent = `${index + 1}. ${sarki.isim} - ${dakika}:${saniye.toString().padStart(2, '0')}`;
        li.className = 'draggable';
        li.draggable = true;

        li.ondragstart = (event) => {
            event.dataTransfer.setData('text', index);
        };
        li.ondragover = (event) => event.preventDefault();
        li.ondrop = (event) => {
            const draggedIndex = event.dataTransfer.getData('text');
            const droppedIndex = index;
            const draggedItem = sarkilar[draggedIndex];
            sarkilar.splice(draggedIndex, 1);
            sarkilar.splice(droppedIndex, 0, draggedItem);
            listeGuncelle();
        };

        const silButonu = document.createElement('button');
        silButonu.textContent = 'Sil';
        silButonu.className = 'delete-button';
        silButonu.onclick = () => sarkiSil(index);

        li.appendChild(silButonu);
        setlistElement.appendChild(li);
    });

    const toplamSure = sarkilar.reduce((acc, sarki) => acc + sarki.sure, 0);
    const toplamDakika = Math.floor(toplamSure);
    const toplamSaniye = Math.round((toplamSure - toplamDakika) * 60);
    document.getElementById('total-time').textContent = `Toplam Süre: ${toplamDakika}:${toplamSaniye.toString().padStart(2, '0')}`;

    if (sarkilar.length > 3) {
        setlistElement.style.overflowY = 'scroll';
    } else {
        setlistElement.style.overflowY = 'hidden';
    }
}

function sarkiSil(index) {
    sarkilar.splice(index, 1);
    listeGuncelle();
}

function exportList() {
    const exportText = sarkilar.map(sarki => `${sarki.isim},${sarki.sure.toFixed(2)}`).join('\n');
    const blob = new Blob([exportText], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.download = 'setlist.txt';
    link.click();
}

function importList(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const importedLines = e.target.result.split('\n');
        const newSarkilar = importedLines.map(line => {
            const [isim, sure] = line.split(',');
            return { isim: isim.trim(), sure: parseFloat(sure) };
        }).filter(sarki => sarki.isim && !isNaN(sarki.sure));

        const toplamSure = newSarkilar.reduce((acc, sarki) => acc + sarki.sure, 0);
        const sureLimit = parseFloat(document.getElementById('sureLimit').value);

        if (toplamSure > sureLimit) {
            alert(`İçe aktarılan liste toplam süresi ${sureLimit} dakikayı aşıyor!`);
            return;
        }

        sarkilar = newSarkilar;
        listeGuncelle();
    };

    reader.readAsText(file);
}

function importFromURL() {
    const url = document.getElementById('urlInput').value;
    if (!url) return;

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('URL yüklenemedi.');
            }
            return response.text();
        })
        .then(data => {
            const importedLines = data.split('\n');
            const newSarkilar = importedLines.map(line => {
                const [isim, sure] = line.split(',');
                return { isim: isim.trim(), sure: parseFloat(sure) };
            }).filter(sarki => sarki.isim && !isNaN(sarki.sure));

            const toplamSure = newSarkilar.reduce((acc, sarki) => acc + sarki.sure, 0);
            const sureLimit = parseFloat(document.getElementById('sureLimit').value);

            if (toplamSure > sureLimit) {
                alert(`İçe aktarılan liste toplam süresi ${sureLimit} dakikayı aşıyor!`);
                return;
            }

            sarkilar = newSarkilar;
            listeGuncelle();
        })
        .catch(error => alert(`URL üzerinden listeyi yüklerken bir hata oluştu: ${error.message}`));
}

function exportPDF() {
    const documentDefinition = {
        content: [
            { text: 'Setlist', style: 'header', absolutePosition: { x: 65, y: 60 } }, 
            ...sarkilar.map((sarki, index) => ({
                text: [
                    { text: `${index + 1}. `, style: 'regular' },
                    { text: sarki.isim, bold: true, fontSize: 18 },
                    { text: ` - (${sarki.sure.toFixed(2)} dk.)`, italics: true, style: 'regular' }
                ],
                absolutePosition: { x: 65, y: 100 + index * 25 }
            }))
        ],
        styles: {
            header: {
                fontSize: 18,
                bold: false
            },
            regular: {
                fontSize: 14,
                bold: false
            }
        }
    };

    pdfMake.createPdf(documentDefinition).download('setlist.pdf');
}

</script>

</body>
</html>
